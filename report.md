
## Stream Cipher с RC4

### Основная концепция

- Поточный шифр - генерирует бесконечную псевдослучайную последовательность (keystream)
- Шифрование/дешифрование: Текст XOR Keystream
- Не требует разбиения на блоки
### Два этапа работы:

#### 1. KSA (Key-Scheduling Algorithm)

**Цель**: инициализация внутреннего состояния

```bash
# Инициализация массива S
S = [0, 1, 2, ..., 255]

# Перемешивание с помощью ключа
j = 0
for i in range(256):
    j = (j + S[i] + K[i % len(K)]) % 256
    S[i], S[j] = S[j], S[i]
```

#### 2. PRGA (Pseudo-Random Generation Algorithm)

**Цель**: генерация keystream
``` Bash
i = j = 0
while True:
    i = (i + 1) % 256
    j = (j + S[i]) % 256
    S[i], S[j] = S[j], S[i]
    t = (S[i] + S[j]) % 256
    yield S[t]  # Байт keystream
```

### Особенности

- Не требует IV в явном виде
- Простая реализация
- Исторически важный, но сейчас считается небезопасным

---

## AES в режиме ECB (Electronic Codebook)

### Принцип работы

- Каждый блок шифруется независимо
- Одинаковые блоки → одинаковый шифротекст

### Процесс

```
Шифрование: Cᵢ = E(K, Pᵢ)
Дешифрование: Pᵢ = D(K, Cᵢ)
```

### Характеристики

- Простой в реализации
- "Плиточный эффект" - видны паттерны
- Нет распространения ошибок
- Не использует IV
- Требует паддинг

---

##  AES в режиме CBC (Cipher Block Chaining)

### Принцип работы

- Блоки связываются в цепочку
- Каждый блок зависит от предыдущего

### Процесс шифрования

```
C₁ = E(K, P₁ ⊕ IV)
C₂ = E(K, P₂ ⊕ C₁)
Cₙ = E(K, Pₙ ⊕ Cₙ₋₁)
```

### Процесс дешифрования

```
P₁ = D(K, C₁) ⊕ IV
P₂ = D(K, C₂) ⊕ C₁
Pₙ = D(K, Cₙ) ⊕ Cₙ₋₁

```

### Характеристики

- Нет "плиточного эффекта"
- Распространение ошибок
- Требует уникальный IV
- Требует паддинга
-  Критично повторное использование IV

---

## AES в режиме CFB (Cipher Feedback)

### Принцип работы

- Преобразует блочный шифр в поточный
- Самосинхронизирующийся режим
### Процесс

```
Шифрование: Cₙ = Pₙ ⊕ E(K, Cₙ₋₁)
Дешифрование: Pₙ = Cₙ ⊕ E(K, Cₙ₋₁)
```

### Варианты

- CFB128 - блочный режим (требует паддинг)
- CFB8- побайтовый (не требует паддинг)
    
### Характеристики

- Можно использовать как поточный шифр
- Самосинхронизация
- Требует уникальный IV
- Критично повторное использование IV

---

## AES в режиме CTR (Counter)

### Принцип работы

- Поточный шифр на основе счетчика
- Самый популярный современный режим
### Структура счетчика

```
Counter = Nonce || BlockNumber
```

### Процесс

```
Keystreamᵢ = E(K, Nonce || i)
Cᵢ = Pᵢ ⊕ Keystreamᵢ
Pᵢ = Cᵢ ⊕ Keystreamᵢ
```

### Характеристики

- Не требует паддинга
-  Параллельное шифрование
-  Высокая производительность
-  Требует уникальный Nonce
-  Катастрофично повторное использование Nonce

---

## Сравнительная таблица

| Режим   | Тип      | Паддинг    | IV/Nonce         | Параллельность | Безопасность |
| ------- | -------- | ---------- | ---------------- | -------------- | ------------ |
| **ECB** | Блочный  | Требует    | Не использует    | Да             | Низкая       |
| **CBC** | Блочный  | Требует    | Уникальный IV    | Нет            | Хорошая      |
| **CFB** | Поточный | Зависит    | Уникальный IV    | Нет            | Хорошая      |
| **CTR** | Поточный | Не требует | Уникальный Nonce | Да             | Высокая      |
| **RC4** | Поточный | Не требует | Неявный          | Да             | Низкая       |


В ходе лабораторной работы были использованы следующие формулы:

##### Энтропия Шеннона из байтов
```BASH
H = -∑(p_i × log₂(p_i))

H - энтропия Шеннона
p_i - вероятность появления i-го байта (значение от 0x00 до 0xFF)
∑ - суммирование по всем возможным байтам (i = 0...255)
log₂ - логарифм по основанию 2
```
##### Коэффициент корреляции Пирсона

```BASH
corr = ∑[(x_i - μ_x) × (y_i - μ_y)] / √[∑(x_i - μ_x)² × ∑(y_i - μ_y)²]

x_i - значение текущего пикселя
y_i - значение соседнего пикселя
μ_x - среднее значение всех текущих пикселей
μ_y - среднее значение всех соседних пикселей
∑ - суммирование по всем парам соседних пикселей
```

##### NPCR и UACI

```BASH
NPCR = (Количество_измененных_байтов / Общее_количество_байтов) × 100%
NPCR = [∑ D(i,j)] / (M × N) × 100%

где D(i,j) = 1 если байты разные, 0 если одинаковые

UACI = [∑ |B1(i) - B2(i)| / (Общее_количество_байтов × 255)] × 100%
UACI = [∑ |I₁(i,j) - I₂(i,j)| / (M × N × 255)] × 100%
```

##### Avalanche effect

```BASH
Avalanche Effect = (Количество_измененных_битов / Общее_количество_битов) × 100%
AE = [∑ popcount(B1_i ⊕ B2_i)] / (N × 8) × 100%
```

### Метрики для сравнения

| Метрика                      | Описание                                                                                                | Границы приемлемых значений                  |
| ---------------------------- | ------------------------------------------------------------------------------------------------------- | -------------------------------------------- |
| Энтропия (бит)               | Мера случайности/непредсказуемости значений пикселей в канале.                                          | Близко к 8 (например, 7.9 и выше)            |
| Корреляция (коэффициент)     | Мера линейной зависимости между соседними пикселями.                                                    | Близко к 0 (например, ±0.1 и меньше)         |
| NPCR (%)                     | Number of Pixels Change Rate: Процент пикселей, изменившихся при небольшом изменении ключа/изображения. | Близко к 100% (например, 99% и выше)         |
| UACI (%)                     | Unified Average Changing Intensity: Средняя интенсивность изменения пикселей.                           | Для 8-битных изображений: около 33.4%        |
| Чувствительность к ключу (%) | Доля изменившихся бит в шифре при изменении 1 бита в ключе (avalanche effect).                          | Близко к 50% (например, в диапазоне 45%-55%) |

### Результаты метрик

#### Анализ по методам

###### STREAM
![](_cache/encryption_method_stream.png)
##### AES-ECB
![](_cache/encryption_method_ecb.png)
##### AES-CBC
![](_cache/encryption_method_cbc.png)
##### AES-CFB
![](_cache/encryption_method_cfb.png)
##### AES-CTR
![](_cache/encryption_method_ctr.png)
#### Общие сравнительные таблицы

#### Энтропия

![](_cache/entropy_comparison1.png)
#### Выводы: 

- Все значения ≈ 7.999-8.000
- Лучшие результаты: у CTR и CBC, режимы показывают стабильно 7.99999
- Худший результат у ECB, режим для checkerboard - только 6.41. Режим ECB шифрует одинаковые блоки одинаково. Шахматная доска состоит из повторяющихся паттернов (черные/белые блоки), следовательно, появляются видимые паттерны в зашифрованном изображении. низкое разнообразие данных => ниже энтропия

##### Метрики безопасности

![](_cache/security_metrics_comparison1.png)
#### Выводы: 
##### 1. NPCR 

- Все результаты: 99.59%-100% 
- Отличная чувствительность к изменению входных данных
- Лучшие метрики: ECB режим дает 100% для checkerboard
- Метрики стабильны, все алгоритмы превышают порог 99.59%

##### 2. UACI 

- Все результаты в пределах 25-38% (идеальный диапазон 33-35%)
- Значения зависят от типа изображения:
    - Noise texture: ~25% (из-за изначально высокой случайности)
    - Gradient: ~32% (средние значения, плавные переходы)
    - Checkerboard/My: ~35-38% (высокий UACI благодаря резким перепадам яркости)

##### 3. Avalanche Effect

- Полученные метрики в пределах: 49.95-51.69% (идеально 50%)
- Большинство значений 49.99-50.03%
- ECB для checkerboard - 51.69% (небольшое отклонение). это происходит потому что в ECB при изменении одного пикселя меняется только один блок, а остальные идентичные блоки остаются неизменными. Это нарушает равномерное распространение изменений по всему изображению.

##### 4. Обобщения по метрикам безопасности:

- Avalanche эффект у всех методов практически идеален
- NPCR в основном соответствует теоретическому идеалу
- UACI сильно зависит от типа исходного изображения
- Все методы шифрования демонстрируют высокий уровень безопасности

##### Корреляция

![](_cache/correlation_comparison1.png)
#### Выводы:

1. Горизонтальная корреляция до шифрования: checkerboard: 0.941, gradient: 0.99996 (почти идеальная линейная зависимость), my: 0.992 (очень высокая), Noise texture: 0.966 (высокая, но меньше чем у градиента)
 2. После шифрования все значения горизонтальной корреляции близки к **0** (±0.004) кроме ECB
 3. Некоторые значения ECB принимают отрицательные значения, это обьъясняется тем, что в ECB одинаковые блоки шифруются одинаково, создавая антикоррелированные паттерны: соседние пиксели в зашифрованном изображении становятся статистически противоположными.
 4. Все остальные режимы - отличные результаты:
	 - CBC/CTR/CFB/Stream: корреляция 0.000±0.004
	 - Статистически неотличимо от нуля
	 - Полное разрушение пространственных зависимостей

##### Размеры файлов

![](_cache/file_size_comparison.png)
#### Выводы:

- ECB и CBC наблюдаются незначительное увеличение (+16 байт) из-за выравнивания
- Остальные размер сохраняют точно

#### Графики

##### Сравнительные сводные гистограммы 
![](_cache/comparative_analysis.png)
![](_cache/correlation_comparison.png)

![](_cache/entropy_comparison.png)
![](_cache/security_metrics_comparison.png)
##### Графики для отдельных методов 
![](_cache/gradient_cbc_dashboard.png)
